(()=>{"use strict";console.log("loaded");const e=io(),t=io("/file"),s=document.getElementById("messages"),a=window.innerHeight,n=document.getElementById("replyToast"),o=document.getElementById("lightbox__close"),l=document.getElementById("textbox"),r=(document.querySelector(".options"),document.querySelector(".copyOption")),i=document.querySelector(".downloadOption"),c=document.querySelector(".deleteOption"),d=document.querySelector(".replyOption"),m=document.querySelector(".fileDropZone"),u=document.getElementById("showMoreReactBtn"),g=new Audio("/sounds/incommingmessage.mp3"),y=new Audio("/sounds/outgoingmessage.mp3"),p=new Audio("/sounds/join.mp3"),h=new Audio("/sounds/leave.mp3"),f=new Audio("/sounds/typing.mp3"),v=new Audio("/sounds/location.mp3"),E=new Audio("/sounds/react.mp3"),I=new Audio("/sounds/click.mp3"),S=new Audio("/sounds/sticker.mp3"),q=document.getElementById("send"),x=document.getElementById("photo"),L=document.getElementById("file");let B,w=!1;const k={primary:["ğŸ’™","ğŸ˜‚","ğŸ˜®","ğŸ˜¢","ğŸ˜ ","ğŸ™‚"],expanded:["â¤ï¸","ğŸ˜","ğŸ˜¡","ğŸ‘","ğŸ‘ŒğŸ»","ğŸ‘ğŸ»","ğŸ‘ğŸ»","ğŸ‘€","ğŸ¤£","ğŸ¤”","ğŸ¤¦","ğŸ¤·","ğŸ™†â€â™€ï¸","ğŸ¤¦â€â™‚ï¸","ğŸ¤·â€â™‚ï¸","ğŸ™†â€â™‚ï¸","ğŸ™„","ğŸ¤­","ğŸ¤«","ğŸ¤©","ğŸ¤¯","ğŸ¤®","ğŸ¤¢","ğŸ¤§","ğŸ¤ ","ğŸ¤¡","ğŸ¤¥","ğŸ¤¤","ğŸ¤¬","ğŸ¤ª","ğŸ¤¨","ğŸ¤—","ğŸ¤‘","ğŸ¤“","ğŸ¤«","ğŸ˜¶","ğŸ˜","ğŸ˜‘","ğŸ˜¬","ğŸ˜","ğŸ˜’","ğŸ˜³","ğŸ˜","ğŸ˜Ÿ","ğŸ˜¤","ğŸ˜­","ğŸ˜ª","ğŸ˜´","ğŸ˜µ","ğŸ˜²","ğŸ˜·","ğŸ˜±","ğŸ˜¨","ğŸ˜°"]};k.primary.forEach((e=>{document.getElementById("reactOptions").insertAdjacentHTML("afterbegin",`<div class="${e}">${e}</div>`)})),k.expanded.forEach((e=>{document.querySelector(".moreReacts").innerHTML+=`<div class=${e}>${e}</div>`}));const b=new Map,C=new Map,$=new Map;let T,M=!1,A=!1,_=s.scrollTop,R=0,H={data:"",name:"",size:"",ext:""},D={data:"",name:"",size:"",ext:""},F="",N={sender:"",message:"",type:"",id:""},U={fileName:"",fileData:""},z={sender:"",message:"",type:"",id:""},O=null;const P=/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);class Y{constructor(e,t,s){this.target=e,this.callback=s,this.isHeld=!1,this.activeHoldTimeoutId=null,this.timeOut=t,["touchstart","mousedown"].forEach((e=>{try{this.target.addEventListener(e,this._onHoldStart.bind(this))}catch(e){console.log(e)}})),["touchmove","mousemove"].forEach((e=>{try{this.target.addEventListener(e,this._onHoldMove.bind(this))}catch(e){console.log(e)}})),["mouseup","touchend","mouseleave","mouseout","touchcancel"].forEach((e=>{try{this.target.addEventListener(e,this._onHoldEnd.bind(this))}catch(e){console.log(e)}}))}_onHoldStart(e){this.isHeld=!0,this.activeHoldTimeoutId=setTimeout((()=>{this.isHeld&&this.callback(e)}),this.timeOut)}_onHoldMove(){this.isHeld=!1}_onHoldEnd(){this.isHeld=!1,clearTimeout(this.activeHoldTimeoutId)}static applyTo(e,t,s){try{new Y(e,t,s)}catch(e){console.log(e)}}}function K(){document.documentElement.style.setProperty("--app-height",`${window.innerHeight}px`)}function W(e=10){let t="",s="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz",a=s.length;for(let n=0;n<e;n++)t+=s.charAt(Math.floor(Math.random()*a));return t}function Z(t,a,n,o,l,r,i,c){i||(i={reply:!1,title:!1});let d="",m=s.querySelector(".message:last-child"),u="",g=X(t);if("text"===a)u=t.length>20?`${t.substring(0,20)} ...`:t,t=`<p class='text'>${t=function(e){return(e=(e=(e=function(e){let t,s,a,n;return s=/(\b(https?|ftp):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/gim,t=e.replace(s,'<a href="$1" target="_blank">$1</a>'),a=/(^|[^\/])(www\.[\S]+(\b|$))/gim,t=t.replace(a,'$1<a href="http://$2" target="_blank">$2</a>'),n=/(([a-zA-Z0-9\-\_\.])+@[a-zA-Z\_]+?(\.[a-zA-Z]{2,6})+)/gim,t=t.replace(n,'<a href="mailto:$1">$1</a>'),t}((t=e,e=(t=(t=(t=(t=(t=(t=(t=(t=(t=(t=(t=(t=(t=(t=(t=(t=(t=t.replace(/fuck/g,"f**k")).replace(/shit/g,"s**t")).replace(/bitch/g,"b**t")).replace(/asshole/g,"a**hole")).replace(/dick/g,"d**k")).replace(/pussy/g,"p**s")).replace(/cock/g,"c**k")).replace(/baal/g,"b**l")).replace(/sex/g,"s*x")).replace(/Fuck/g,"F**k")).replace(/Shit/g,"S**t")).replace(/Bitch/g,"B**t")).replace(/Asshole/g,"A**hole")).replace(/Dick/g,"D**k")).replace(/Pussy/g,"P**s")).replace(/Cock/g,"C**k")).replace(/Baal/g,"B**l")).replace(/Sex/g,"S*x")))).replaceAll(/```Â¶/g,"```")).replaceAll(/```([^`]+)```/g,"<code>$1</code>")).replaceAll("Â¶","<br>");var t}(t)}</p>`;else if("image"===a)u="Image",t=`<img class='image' src='${t}' alt='image' height='${c.height}' width='${c.width}' /><div class='sendingImage'>Wait..</div>`;else if("sticker"===a)u="Sticker",t=`<img class='sticker' src='/stickers/${t}.webp' alt='sticker' height='${c.height}' width='${c.width}' />`;else if("text"!=a&&"image"!=a&&"file"!=a&&"sticker"!=a)throw new Error("Invalid message type");o==myId&&(d+=" self"),m?.dataset?.uid!=o||g||"sticker"===a?d+=" start end":m?.dataset?.uid==o&&(i.reply||m?.classList.contains("emoji")||m?.classList.contains("sticker")?d+=" start":m?.classList.remove("end"),d+=" end"),g&&(m?.classList.add("end"),d+=" emoji"),"sticker"===a&&(m?.classList.add("end"),d+=" sticker"),i.reply||(d+=" noreply"),i.title&&d.includes("start")?d.includes("self")&&d.includes("noreply")&&(d+=" notitle"):d+=" notitle";let y,p,h,f,v,E=C.get(o)?.name,I=C.get(o)?.avatar;E==myName&&(E="You"),i.reply&&(v=C.get(document.getElementById(r||"")?.dataset?.uid)?.name,v==myName&&(v="You"),v==E&&(v="self"),document.getElementById(r)||(l={data:"Message is not available on this device",type:"text"}),"text"===l.type||"file"===l.type?(h=l.data,f="message"):"image"===l.type?(h=document.getElementById(r)?.querySelector(".messageMain .image").outerHTML.replace('class="image"','class="image imageReply"'),f="image"):"sticker"===l.type&&(h=document.getElementById(r)?.querySelector(".messageMain .sticker").outerHTML.replace('class="sticker"','class="sticker imageReply"'),f="image")),"file"===a?(u="File",y=document.getElementById("fileTemplate").innerHTML,p=Mustache.render(y,{classList:d,avatar:`<img src='/images/avatars/${I}(custom).png' width='30px' height='30px' alt='avatar' />`,messageId:n,uid:o,type:a,repId:r,title:i.reply?`${E} replied to ${v||"a message"}`:E,data:t,fileName:c.name,fileSize:c.size,ext:c.ext,replyMsg:h,replyFor:f,time:j()})):(y=document.getElementById("messageTemplate").innerHTML,p=Mustache.render(y,{classList:d,avatar:`<img src='/images/avatars/${I}(custom).png' width='30px' height='30px' alt='avatar' />`,messageId:n,uid:o,type:a,repId:r,title:i.reply?`${E} replied to ${v||"a message"}`:E,message:t,replyMsg:h,replyFor:f,time:j()})),O=n,document.hasFocus()&&e.emit("seen",{userId:myId,messageId:O,avatar:myAvatar});const S=document.createDocumentFragment();S.append(document.createRange().createContextualFragment(p)),s.append(S),"image"!=l.type&&"sticker"!=l.type||document.getElementById(n).querySelector(".messageReply")?.classList.add("imageReply"),_=s.scrollTop,te(m?.id),oe(C.get(o)?.avatar,u)}function j(){return new Intl.DateTimeFormat("en-US",{hour:"numeric",minute:"numeric",hour12:!0}).format(new Date)}function X(e){if(/^([\uD800-\uDBFF][\uDC00-\uDFFF])+$/.test(e))return e=e.replace(/\s/g,""),!0}function G(e){let t=e.target;(t.classList.contains("close_area")||"optionsContainer"==t.id)&&Q(),function(e){let t=e.target?.classList[0];console.log(t),t&&V(t)}(e)}function J(){try{console.log("Saving image");let e=document.createElement("a");e.href=document.querySelector("#lightbox__image img").src,e.download=`poketab-${Date.now()}`,document.body.appendChild(e),e.click(),document.body.removeChild(e)}catch(e){console.log(e)}}function V(t){if(k.primary.includes(t)||k.expanded.includes(t)){let s=N.id;e.emit("react",t,s,myId),Q()}}function Q(){let e=document.getElementById("optionsContainerWrapper");document.querySelector(".reactOptionsWrapper").dataset.closed="false",Ie(),e.classList.remove("active"),document.getElementById("sidebar_wrapper").classList.remove("active"),document.querySelector(".themeChooser").classList.remove("active"),setTimeout((()=>{r.style.display="none",i.style.display="none",c.style.display="none",e.style.display="none"}),20),document.getElementById("focus_glass").classList.remove("active"),document.querySelector(".reactorContainerWrapper").classList.remove("active"),e.removeEventListener("click",G)}function ee(){n.classList.remove("active"),n.querySelector(".replyData").textContent="",n.querySelector(".username").textContent="",_=s.scrollTop,se()}function te(e){try{if(e){let t=document.getElementById(e),s=t?.nextElementSibling;t.classList.contains("react")?t.querySelector(".seenBy").hasChildNodes()?(t.style.marginBottom="0px",t.querySelectorAll(".seenBy img").forEach((e=>e.style.marginTop="12px"))):t.style.marginBottom="12px":(t.style.marginBottom="0px",t.querySelector(".seenBy").hasChildNodes()&&t.querySelectorAll(".seenBy img").forEach((e=>e.style.marginTop="0px"))),null!=t&&null!=s&&t?.dataset.uid===s?.dataset.uid&&(t.dataset.uid==myId?Math.abs(t.querySelector(".messageContainer").getBoundingClientRect().bottom-s.querySelector(".messageContainer").getBoundingClientRect().top)>2?(t.querySelector(".messageMain > *").style.borderBottomRightRadius="15px",s.querySelector(".messageMain > *").style.borderTopRightRadius="15px"):t.classList.contains("end")||s.classList.contains("start")||(t.querySelector(".messageMain > *").style.borderBottomRightRadius="3px",s.querySelector(".messageMain > *").style.borderTopRightRadius="3px"):Math.abs(t.querySelector(".messageContainer").getBoundingClientRect().bottom-s.querySelector(".messageContainer").getBoundingClientRect().top)>2?(t.querySelector(".messageMain > *").style.borderBottomLeftRadius="15px",s.querySelector(".messageMain > *").style.borderTopLeftRadius="15px"):t.classList.contains("end")||s.classList.contains("start")||(t.querySelector(".messageMain > *").style.borderBottomLeftRadius="3px",s.querySelector(".messageMain > *").style.borderTopLeftRadius="3px"))}}catch(e){console.log(e)}}function se(){N.sender="",N.message="",N.type="",N.id=""}function ae(){z.sender="",z.message="",z.type="",z.id=""}function ne(e){let t,s=!!e.target.closest(".message").classList.contains("self");if(e.target.closest(".messageMain")?.querySelector(".text"))t="text",N.sender=C.get(e.target.closest(".message")?.dataset?.uid).name,N.sender==myName&&(N.sender="You"),N.message=e.target.closest(".messageMain").querySelector(".text").innerText,N.type=t,N.id=e.target?.closest(".message")?.id;else if(e.target.classList.contains("image")&&!e.target.classList.contains("imageReply")){for(t="image";document.querySelector("#lightbox__image").firstChild;)document.querySelector("#lightbox__image").removeChild(document.querySelector("#lightbox__image").firstChild);const s=document.createDocumentFragment(),a=document.createElement("img");a.src=e.target.closest(".messageMain")?.querySelector(".image").src,a.alt="Image",s.append(a),document.querySelector("#lightbox__image").append(s),N.sender=C.get(e.target.closest(".message")?.dataset?.uid).name,N.sender==myName&&(N.sender="You");let n=e.target.closest(".messageMain").querySelector(".image").cloneNode(!0);N.message=n,N.type=t,N.id=e.target?.closest(".message")?.id}else if(e.target.closest(".messageMain")?.querySelector(".file"))t="file",N.sender=C.get(e.target.closest(".message")?.dataset?.uid).name,N.sender==myName&&(N.sender="You"),U.fileName=e.target.closest(".messageMain").querySelector(".fileName").textContent,U.fileData=e.target.closest(".messageMain").querySelector(".file").dataset.data,N.message=U.fileName,N.type=t,N.id=e.target?.closest(".message")?.id;else if(e.target.closest(".messageMain")?.querySelector(".sticker")){t="sticker",N.sender=C.get(e.target.closest(".message")?.dataset?.uid).name,N.sender==myName&&(N.sender="You");let s=e.target.closest(".messageMain").querySelector(".sticker").cloneNode(!0);N.message=s,N.type=t,N.id=e.target?.closest(".message")?.id}"text"!==t&&"image"!==t&&"file"!==t&&"sticker"!==t||function(e,t,s){if(navigator.vibrate&&navigator.vibrate(50),document.querySelector(".reactorContainerWrapper").classList.remove("active"),document.querySelectorAll("#reactOptions div").forEach((e=>e.style.background="none")),document.querySelectorAll(".moreReacts div").forEach((e=>e.style.background="none")),document.getElementById("showMoreReactBtn").style.background="none",s.classList.contains("imageReply"))return;if("text"===e)r.style.display="flex";else if("image"===e){if("true"!=s.closest(".message")?.dataset.downloaded)return s.closest(".message")?.dataset.uid==myId?de("Not sent yet"):de("Not downloaded yet"),void console.log("%cNot availabe yet","color: red");i.style.display="flex"}else if("file"===e){if("true"!=s.closest(".message")?.dataset.downloaded)return s.closest(".message")?.dataset.uid==myId?de("Not sent yet"):de("Not downloaded yet"),void console.log("%cNot availabe yet","color: red");i.style.display="flex"}if(c.style.display=!0===t?"flex":"none",Array.from(s?.closest(".message")?.querySelectorAll(".reactedUsers .list")).reduce(((e,t)=>e||t.dataset.uid==myId),!1)){let e=s?.closest(".message")?.querySelector(`.reactedUsers [data-uid="${myId}"]`)?.textContent;k.primary.includes(e)?document.querySelector(`#reactOptions .${e}`).style.background=themeAccent[THEME].secondary:k.expanded.includes(e)&&(document.getElementById("showMoreReactBtn").style.background=themeAccent[THEME].secondary,document.querySelector(`.moreReacts .${e}`).style.background=themeAccent[THEME].secondary)}let a=document.getElementById("optionsContainerWrapper");a.style.display="grid",setTimeout((()=>{a.classList.add("active"),document.getElementById("focus_glass").classList.add("active"),a.addEventListener("click",G)}),20)}(t,s,e.target)}function oe(e=null,t=""){A?t.length>0&&null!=e&&(document.querySelector(".newmessagepopup img").style.display="block",document.querySelector(".newmessagepopup .msg").style.display="block",document.querySelector(".newmessagepopup .downarrow").style.display="none",document.querySelector(".newmessagepopup img").src=`/images/avatars/${e}(custom).png`,document.querySelector(".newmessagepopup .msg").textContent=t,document.querySelector(".newmessagepopup").classList.add("active")):setTimeout((()=>{let e=document.getElementById("messages");e.scrollTo(0,e.scrollHeight),_=e.scrollTop}),20)}function le(){document.querySelector(".newmessagepopup").classList.remove("active"),document.querySelector(".newmessagepopup img").style.display="none",document.querySelector(".newmessagepopup .downarrow").style.display="none"}function re(e){if(e.size>0){const t=Array.from(e.values());let s="";return t.length>=1&&(s=1==t.length?t[0]:2==t.length?`${t[0]} and ${t[1]}`:3==t.length?`${t[0]}, ${t[1]} and ${t[2]}`:`${t[0]}, ${t[1]}, ${t[2]} and ${t.length-3} other${t.length-3>1?"s":""}`),s+=(t.length>1?" are ":" is ")+" typing...",s}return""}function ie(){l.style.height="auto",l.style.height=l.scrollHeight+"px"}function ce(e){null==e&&(e=N.message),navigator.clipboard?(navigator.clipboard.writeText(e),de("Copied to clipboard")):de("This browser does't support clipboard access")}function de(e){document.querySelector(".popup-message").textContent=e,document.querySelector(".popup-message").classList.add("active"),setTimeout((function(){document.querySelector(".popup-message").classList.remove("active")}),1e3)}let me;P&&Y.applyTo(s,300,(e=>{"true"==e.target.closest(".message").dataset.deleted||ne(e)})),P||s.addEventListener("contextmenu",(e=>{if(e.preventDefault(),e.stopPropagation(),3==e.which){let t=e.target.closest(".message")??!1,s="true"==e.target.closest(".message")?.dataset.deleted;t&&!s&&ne(e)}})),window.addEventListener("focus",(()=>{null!=T&&T.close(),e.emit("seen",{userId:myId,messageId:O,avatar:myAvatar})}));let ue,ge,ye="";ue=Stickers[0].name,ge=Stickers[0].count;const pe=document.getElementById("selectStickerGroup");function he(){document.getElementById("focus_glass").classList.remove("active"),document.getElementById("stickersPanel").classList.remove("active"),setTimeout((()=>{document.getElementById("stickersPanel").style.display="none"}),20)}let fe,ve,Ee;function Ie(){let e=document.querySelector(".reactOptionsWrapper");"true"==e.dataset.closed?(e.style.maxHeight="200px",e.dataset.closed="false",e.querySelector(".fa-solid").classList.replace("fa-plus","fa-chevron-up"),document.querySelector(".moreReacts").classList.add("active")):(e.style.maxHeight="35px",e.dataset.closed="true",e.querySelector(".fa-solid").classList.replace("fa-chevron-up","fa-plus"),document.querySelector(".moreReacts").classList.remove("active"))}function Se(e=null){let t=e||x.files[0];if(t.size>15728640)return void de("File size too large");for(document.getElementById("previewImage").querySelector("#imageSend").style.display="none";document.getElementById("selectedImage").firstChild;)document.getElementById("selectedImage").removeChild(document.getElementById("selectedImage").firstChild);const s=document.createRange().createContextualFragment(`<span class='load' style='color: ${themeAccent[THEME].secondary};'>Reading binary data</span>&nbsp;<i class="fa-solid fa-gear fa-spin"></i>`);document.getElementById("selectedImage").append(s),document.getElementById("previewImage")?.classList?.add("active");let a=new FileReader;a.readAsDataURL(t),a.onload=e=>{let s=e.target.result;for(H.data=s,H.name=t.name,H.ext=t.type.split("/")[1],H.size=t.size,F="image";document.getElementById("selectedImage").firstChild;)document.getElementById("selectedImage").removeChild(document.getElementById("selectedImage").firstChild);const a=document.createRange().createContextualFragment(`<img src="${s}" alt="image" class="image-message" />`);document.getElementById("selectedImage").append(a),document.getElementById("previewImage").querySelector("#imageSend").style.display="block"},x.value="",L.value=""}function qe(e=null){for(document.getElementById("previewImage").querySelector("#imageSend").style.display="none";document.getElementById("selectedImage").firstChild;)document.getElementById("selectedImage").removeChild(document.getElementById("selectedImage").firstChild);const t=document.createRange().createContextualFragment(`<span class='load' style='color: ${themeAccent[THEME].secondary};'>Reading binary data</span>&nbsp;<i class="fa-solid fa-circle-notch fa-spin"></i>`);document.getElementById("selectedImage").append(t),document.getElementById("previewImage")?.classList?.add("active");let s=e||L.files[0],a=s.name,n=s.size,o=a.split(".").pop();if(n<1024?n+="b":n=n<1048576?(n/1024).toFixed(1)+"kb":(n/1048576).toFixed(1)+"mb",s.size>15e6){for(de("File size must be less than 15 mb"),document.getElementById("previewImage")?.classList.remove("active");document.getElementById("selectedImage").firstChild;)document.getElementById("selectedImage").removeChild(document.getElementById("selectedImage").firstChild);return}let l=new FileReader;l.readAsDataURL(s),l.onload=e=>{let t=e.target.result;for(D.data=t,D.name=a,D.size=n,D.ext=o,F="file";document.getElementById("selectedImage").firstChild;)document.getElementById("selectedImage").removeChild(document.getElementById("selectedImage").firstChild);const s=document.createRange().createContextualFragment(`<div class='file_preview'><i class="fa-regular fa-file-lines"></i><div>File: ${a.length>=25?a.substring(0,10)+"..."+a.substring(a.length-10,a.length):a}</div><div>Size: ${n}</div></div>`);document.getElementById("selectedImage").append(s),document.getElementById("previewImage").querySelector("#imageSend").style.display="block"},x.value="",L.value=""}function xe(e,t){let s=e.split(","),a=(s[0].match(/:(.*?);/)[1],window.atob(s[1])),n=a.length,o=new Uint8Array(n);for(;n--;)o[n]=a.charCodeAt(n);return new File([o],t+".qml")}function Le(e,t,s){"Notification"in window?"granted"===Notification.permission?document.hasFocus()||(document.querySelector("title").text=`${t} messaged`,null==Ee&&(Ee=setTimeout((()=>{document.querySelector("title").text="Inbox",Ee=void 0}),3e3)),T=new Notification(t,{body:"Text"==e.type?e.data:e.type,icon:`/images/avatars/${s}(custom).png`,tag:t})):"denied"!==Notification.permission&&Notification.requestPermission().then((a=>{"granted"===a&&(document.hasFocus()||(document.querySelector("title").text=`${t} messaged`,null==Ee&&(Ee=setTimeout((()=>{document.querySelector("title").text="Inbox",Ee=void 0}),3e3)),T=new Notification(t,{body:"Text"==e.type?e.data:e.type,icon:`/images/avatars/${s}(custom).png`,tag:t})))})):alert("This browser does not support desktop notification")}document.getElementById("closeStickersPanel").addEventListener("click",(()=>{_=s.scrollTop,he(),oe()})),document.querySelector(".fa-angle-left").addEventListener("click",(()=>{pe.scrollTo({left:pe.scrollLeft-60,behavior:"smooth"})})),document.querySelector(".fa-angle-right").addEventListener("click",(()=>{pe.scrollTo({left:pe.scrollLeft+60,behavior:"smooth"})})),document.querySelector(".stickerBtn").addEventListener("click",(()=>{oe(),function(){ye="",me=Stickers.map((e=>{if(e.name!=ue)return`<img src="/stickers/${e.name}/animated/${e.icon}.webp" alt="${e.name}" data-name="${e.name}" class="stickerName clickable">`})).join(""),me=`<img src="/stickers/${ue}/animated/${Stickers.find((e=>e.name==ue)).icon}.webp" alt="${ue}" data-name="${ue}" class="stickerName clickable selected">`+me;for(let e=1;e<=ge;e++)ye+=`<img src="/stickers/${ue}/static/${e}.webp" alt="${ue}-${e}" data-name="${ue}/animated/${e}" class="stickerpack clickable">`;pe.innerHTML=me,document.getElementById("stickers").innerHTML=ye,document.querySelector('.names > img[data-name="'+ue+'"]').dataset.selected="true"}(),document.getElementById("stickersPanel").style.display="flex",setTimeout((()=>{document.getElementById("focus_glass").classList.add("active"),document.getElementById("stickersPanel").classList.add("active")}),20)})),document.getElementById("selectStickerGroup").addEventListener("click",(e=>{if("IMG"===e.target.tagName){document.getElementById("stickers").innerHTML='Loading&nbsp;<i class="fa-solid fa-circle-notch fa-spin" style="color: var(--secondary-dark)"></i>',document.getElementById("selectStickerGroup").querySelectorAll(".stickerName").forEach((e=>{e.dataset.selected="false"})),ue=e.target.dataset.name,ge=Stickers.find((e=>e.name===ue)).count,ye="";for(let e=1;e<=ge;e++)ye+=`<img src="/stickers/${ue}/static/${e}.webp" alt="${ue}-${e}" data-name="${ue}/animated/${e}" class="stickerpack clickable">`;document.querySelector('.names > img[data-name="'+ue+'"]').dataset.selected="true",document.getElementById("stickers").innerHTML=ye}})),document.getElementById("stickers").addEventListener("click",(t=>{if("IMG"===t.target.tagName){document.getElementById("stickers").querySelectorAll(".stickerpack").forEach((e=>{e.style.background="transparent"})),t.target.style.background=themeAccent[THEME].msg_send;let s=W();S.play(),A=!1,oe(),Z(t.target.dataset.name,"sticker",s,myId,{data:z?.message,type:z?.type},z?.id,{reply:!!z.message,title:!!(z.message||maxUser>2)},{}),e.emit("message",t.target.dataset.name,"sticker",myId,{data:z?.message,type:z?.type},z?.id,{reply:!!z.message,title:!!(z.message||maxUser>2)},(function(t){y.play(),document.getElementById(s).classList.add("delevered"),document.getElementById(s).id=t,O=t,document.hasFocus()&&e.emit("seen",{userId:myId,messageId:O,avatar:myAvatar})})),se(),ae(),ee(),he()}})),document.getElementById("more").addEventListener("click",(()=>{document.getElementById("sidebar_wrapper").classList.add("active"),document.getElementById("focus_glass").classList.add("active")})),document.querySelectorAll(".keyCopy").forEach((e=>{e.addEventListener("click",(e=>{let t=e.target.closest(".keyCopy").querySelector(".fa-clone");t.classList.replace("fa-clone","fa-check"),t.classList.replace("fa-regular","fa-solid"),t.style.color="var(--secondary-dark)",fe&&clearTimeout(fe),fe=setTimeout((()=>{t.classList.replace("fa-check","fa-clone"),t.classList.replace("fa-solid","fa-regular"),t.style.color="var(--secondary-dark)"}),1e3),ce(myKey)}))})),document.getElementById("invite").addEventListener("click",(async()=>{try{if(!navigator.share)return void de("Sharing in not supported by this browser");await navigator.share({title:"Poketab Messanger",text:"Join chat!",url:`https://${window.location.host}/join/${myKey}`}),de("Shared!")}catch(e){de(`${e}`)}})),document.querySelector(".theme_option").addEventListener("click",(()=>{Q(),THEME&&(document.querySelector(".themeChooser").querySelectorAll(".theme").forEach((e=>{e.querySelector("img").style.border=""})),document.querySelector(`.themeChooser #${THEME}`).querySelector("img").style.border="2px solid var(--secondary-dark)"),document.getElementById("focus_glass").classList.add("active"),document.querySelector(".themeChooser").classList.add("active")})),document.querySelector(".themeChooser").addEventListener("click",(()=>{document.querySelector(".themeChooser").classList.remove("active"),Q()})),document.querySelectorAll(".theme").forEach((e=>{e.addEventListener("click",(e=>{THEME=e.target.closest("li").id,localStorage.setItem("theme",THEME),console.log(`Theme changed to ${THEME}`),document.documentElement.style.setProperty("--pattern",`url('../images/backgrounds/${THEME}_w.webp')`),document.documentElement.style.setProperty("--secondary-dark",themeAccent[THEME].secondary),document.documentElement.style.setProperty("--msg-get",themeAccent[THEME].msg_get),document.documentElement.style.setProperty("--msg-get-reply",themeAccent[THEME].msg_get_reply),document.documentElement.style.setProperty("--msg-send",themeAccent[THEME].msg_send),document.documentElement.style.setProperty("--msg-send-reply",themeAccent[THEME].msg_get_reply),document.querySelector(".themeChooser").classList.remove("active"),document.querySelector('meta[name="theme-color"]').setAttribute("content",themeAccent[THEME].secondary),Q()}))})),u.addEventListener("click",(()=>{console.log("show more"),Ie()})),document.querySelector(".moreReacts").addEventListener("click",(e=>{let t=e.target;if(t!=document.querySelector(".moreReacts")){let e=t.textContent;console.log(e),V(e),Q()}})),s.addEventListener("scroll",(()=>{R=s.scrollTop;let e=_-R;R<=_?(e>=50&&(A=!0),0==e&&(document.querySelector(".newmessagepopup").classList.remove("active"),A=!1)):(_=R,le(),A=!1),e>=300&&(document.querySelector(".newmessagepopup img").style.display="none",document.querySelector(".newmessagepopup .msg").style.display="none",document.querySelector(".newmessagepopup .downarrow").style.display="block",document.querySelector(".newmessagepopup").classList.add("active"))})),l.addEventListener("input",(function(){ie(),B&&(clearTimeout(B),B=void 0),w||(w=!0,e.emit("typing")),B=setTimeout((function(){w=!1,e.emit("stoptyping")}),1e3)})),document.querySelector(".newmessagepopup").addEventListener("click",(function(){A=!1,oe(),le()})),document.getElementById("logout").addEventListener("click",(()=>{document.getElementById("preload").querySelector(".text").textContent="Logging out",document.getElementById("preload").style.display="flex",window.location.href="/"})),n.querySelector(".close").addEventListener("click",(()=>{se(),ae(),ee()})),document.addEventListener("contextmenu",(e=>e.preventDefault())),o.addEventListener("click",(()=>{for(document.getElementById("lightbox").classList.remove("active");document.getElementById("lightbox__image").firstChild;)document.getElementById("lightbox__image").removeChild(document.getElementById("lightbox__image").firstChild)})),l.addEventListener("focus",(function(){oe()})),l.addEventListener("blur",(()=>{M&&l.focus()})),document.querySelector(".close_area").addEventListener("click",(e=>{document.getElementById("sidebar_wrapper").classList.remove("active"),Q()})),document.getElementById("attmain").addEventListener("click",(e=>{document.getElementById("attmain").classList.remove("active"),setTimeout((()=>{document.getElementById("attmain").style.display="none"}),20)})),document.getElementById("attachment").addEventListener("click",(()=>{document.getElementById("attmain").style.display="flex",setTimeout((()=>{document.getElementById("attmain").classList.add("active")}),20)})),document.querySelector(".reactOptionsWrapper").addEventListener("click",(e=>{e.target.classList.contains("reactOptionsWrapper")&&Q()})),s.addEventListener("click",(e=>{try{if(e.target?.closest(".message")?.contains(e.target)&&!e.target?.classList.contains("message")&&(e.target?.closest(".message")?.querySelector(".messageTime")?.classList?.add("active"),setTimeout((()=>{e.target?.closest(".message")?.querySelector(".messageTime")?.classList?.remove("active")}),1500)),e.target?.classList?.contains("image")&&!e.target?.classList?.contains("imageReply")){if(e.preventDefault(),e.stopPropagation(),"true"!=e.target.closest(".message")?.dataset.downloaded)return e.target.closest(".message")?.dataset.uid==myId?de("Not sent yet"):de("Not downloaded yet"),void console.log("%cNot availabe yet","color: blue");for(;document.getElementById("lightbox__image").firstChild;)document.getElementById("lightbox__image").removeChild(document.getElementById("lightbox__image").firstChild);const t=document.createRange().createContextualFragment(`<img src=${e.target?.src} class='lb'>`);document.getElementById("lightbox__image").append(t),function(e){let t=1,s={};const a=e=>Math.hypot(e.touches[0].pageX-e.touches[1].pageX,e.touches[0].pageY-e.touches[1].pageY);e.addEventListener("touchstart",(e=>{2===e.touches.length&&(e.preventDefault(),s.x=(e.touches[0].pageX+e.touches[1].pageX)/2,s.y=(e.touches[0].pageY+e.touches[1].pageY)/2,s.distance=a(e))})),e.addEventListener("touchmove",(n=>{if(2===n.touches.length){let o;n.preventDefault(),o=n.scale?n.scale:a(n)/s.distance,t=Math.min(Math.max(1,o),4);const l=`translate3d(${2*((n.touches[0].pageX+n.touches[1].pageX)/2-s.x)}px, ${2*((n.touches[0].pageY+n.touches[1].pageY)/2-s.y)}px, 0) scale(${t})`;e.style.transform=l,e.style.WebkitTransform=l,e.style.zIndex="9999"}})),e.addEventListener("touchend",(t=>{e.style.transform="",e.style.WebkitTransform="",e.style.zIndex=""}))}(document.getElementById("lightbox__image").querySelector("img")),document.getElementById("lightbox").classList.add("active")}else if(e.target?.classList?.contains("reactsOfMessage")||e.target?.parentNode?.classList?.contains("reactsOfMessage")){let t=e.target?.closest(".message")?.querySelectorAll(".reactedUsers .list"),s=document.querySelector(".reactorContainer ul");for(;s.firstChild;)s.removeChild(s.firstChild);t.length>0&&t.forEach((e=>{let t=C.get(e.dataset.uid).avatar,a=C.get(e.dataset.uid).name;if(a==myName&&(a="You"),e.dataset.uid==myId){const n=document.createRange().createContextualFragment(`<li><img src='/images/avatars/${t}(custom).png' height='30px' width='30px'><span class='uname'>${a}</span><span class='r'>${e.textContent}</span></li>`);s.prepend(n)}else{const n=document.createRange().createContextualFragment(`<li><img src='/images/avatars/${t}(custom).png' height='30px' width='30px'><span class='uname'>${a}</span><span class='r'>${e.textContent}</span></li>`);s.append(n)}})),Q(),document.querySelector(".reactorContainerWrapper").classList.add("active"),document.getElementById("focus_glass").classList.add("active")}else if(e.target?.classList?.contains("messageReply")||e.target?.classList?.contains("imageReply"))if("true"!=document.getElementById(e.target.closest(".messageReply").dataset.repid).dataset.deleted)try{let t=e.target.closest(".messageReply")?.dataset.repid;document.querySelectorAll(".message").forEach((e=>{e.id!=t&&(e.style.filter="brightness(0.5)")})),setTimeout((()=>{document.querySelectorAll(".message").forEach((e=>{e.style.filter=""}))}),1e3),setTimeout((()=>{document.getElementById(t).scrollIntoView({behavior:"smooth",block:"start"})}),20)}catch(e){de("Deleted message")}else de("Deleted message");else Q()}catch(e){console.log("Message does not exist")}})),document.querySelector(".reactorContainerWrapper").addEventListener("click",(e=>{e.target.classList.contains("reactorContainerWrapper")&&Q()})),window.addEventListener("resize",(()=>{K();let e=A;setTimeout((()=>{A=!1,oe()}),20),A=e,M=a>window.innerHeight})),d.addEventListener("click",(function(){Q(),oe(),l.focus(),z=Object.assign({},N),"image"==z.type||"sticker"==z.type?n.querySelector(".replyData").appendChild(z.message):n.querySelector(".replyData").textContent=z.message?.substring(0,50),n.querySelector(".username").textContent=z.sender,n.classList.add("active")})),r.addEventListener("click",(()=>{Q(),ce(null)})),i.addEventListener("click",(function(){"image"===N.type?(document.querySelector("#lightbox__image img").src=N.message.src,J()):function(){let e=U.fileData,t=U.fileName,s=document.createElement("a");s.href=e,s.download=t,document.body.appendChild(s),s.click(),document.body.removeChild(s)}()})),c.addEventListener("click",(()=>{let t=document.getElementById(N.id)?.dataset?.uid;t&&(Q(),e.emit("deletemessage",N.id,t,myName,myId))})),x.addEventListener("change",(()=>{Se()})),L.addEventListener("change",(()=>{qe()})),window.addEventListener("dragover",(e=>{e.preventDefault(),e.stopPropagation(),m.classList.add("active"),e.target.classList.contains("fileDropZoneContent")?(document.querySelector(".fileDropZoneContent").style.color=themeAccent[THEME].secondary,ve&&clearTimeout(ve)):(document.querySelector(".fileDropZoneContent").style.color="#fff",ve&&clearTimeout(ve)),ve=setTimeout((()=>{m.classList.remove("active")}),200)})),window.addEventListener("drop",(e=>{e.preventDefault(),m.classList.remove("active"),e.target.classList.contains("fileDropZoneContent")&&e.dataTransfer.files.length>0&&(e.dataTransfer.files[0].type.includes("image")?Se(e.dataTransfer.files[0]):qe(e.dataTransfer.files[0]))})),window.addEventListener("offline",(function(e){console.log("offline"),document.querySelector(".offline .icon i").classList.replace("fa-wifi","fa-circle-exclamation"),document.querySelector(".offline .text").textContent="You are offline!",document.querySelector(".offline").classList.add("active"),document.querySelector(".offline").style.background="var(--primary-dark)"})),window.addEventListener("online",(function(e){console.log("Back to online"),document.querySelector(".offline .icon i").classList.replace("fa-circle-exclamation","fa-wifi"),document.querySelector(".offline .text").textContent="Back to online!",document.querySelector(".offline").style.background="limegreen",setTimeout((()=>{document.querySelector(".offline").classList.remove("active")}),1500)})),q.addEventListener("click",(()=>{let t=l.value?.trim();if(l.value="",ie(),t.length){let s=W();A=!1,t.length>1e4&&(t=t.substring(0,1e4),t+="... (message too long)"),t=function(e){const t=new Map;t.set(":)","ğŸ™‚"),t.set(":'(","ğŸ˜¢"),t.set(":D","ğŸ˜€"),t.set(":P","ğŸ˜›"),t.set(":p","ğŸ˜›"),t.set(":O","ğŸ˜®"),t.set(":o","ğŸ˜®"),t.set(":|","ğŸ˜"),t.set(":/","ğŸ˜•"),t.set(":*","ğŸ˜˜"),t.set(">:(","ğŸ˜ "),t.set(":(","ğŸ˜"),t.set("o3o","ğŸ˜—"),t.set("^3^","ğŸ˜™"),t.set("^_^","ğŸ˜Š"),t.set("<3","â¤ï¸"),t.set(">_<","ğŸ˜£"),t.set(">_>","ğŸ˜’"),t.set("-_-","ğŸ˜‘"),t.set("XD","ğŸ˜†"),t.set("xD","ğŸ˜†"),t.set("B)","ğŸ˜"),t.set(";)","ğŸ˜‰"),t.set("T-T","ğŸ˜­"),t.set(":aww:","ğŸ¥º"),t.set(":lol:","ğŸ˜‚"),t.set(":haha:","ğŸ¤£"),t.set(":hehe:","ğŸ˜…"),t.set(":meh:","ğŸ˜¶"),t.set(":hmm:","ğŸ˜"),t.set(":wtf:","ğŸ¤¨"),t.set(":yay:","ğŸ¥³"),t.set(":yolo:","ğŸ¤ª"),t.set(":yikes:","ğŸ˜±");for(let[s,a]of t)if(-1!=e.indexOf(s)){let t=e.indexOf(s),n=/[a-zA-Z0-9_!@#$%^&*()+\-=\[\]{};':"\\|,.<>\/?]/;if(e.charAt(t-1).match(n)||e.charAt(t+s.length).match(n))continue;e=e.replaceAll(s,a)}return e}(t),t=t.replace(/\n/g,"Â¶"),t=t.replace(/>/g,"&gt;"),t=t.replace(/</g,"&lt;"),X(t)&&(t=t.replace(/\s/g,""));let a="text"===z?.type?z?.message.substring(0,100):z?.message;Z(t,"text",s,myId,{data:a,type:z?.type},z?.id,{reply:!!z.message,title:!!(z.message||maxUser>2)},{}),e.emit("message",t,"text",myId,{data:a,type:z?.type},z?.id,{reply:!!z.message,title:!!(z.message||maxUser>2)},(function(t){y.play(),document.getElementById(s).classList.add("delevered"),document.getElementById(s).id=t,O=t,document.hasFocus()&&e.emit("seen",{userId:myId,messageId:O,avatar:myAvatar})}))}z.message="",z.type="",z.sender="",z.id="",l.focus(),Q(),ee();try{clearTimeout(B)}catch(e){console.log("timeout not set")}w=!1,e.emit("stoptyping")})),document.getElementById("previewImage").querySelector(".close")?.addEventListener("click",(()=>{for(x.value="",L.value="",document.getElementById("previewImage")?.classList?.remove("active");document.getElementById("selectedImage").firstChild;)document.getElementById("selectedImage").removeChild(document.getElementById("selectedImage").firstChild)})),document.getElementById("previewImage").querySelector("#imageSend")?.addEventListener("click",(()=>{document.getElementById("previewImage")?.classList?.remove("active"),"image"===F?async function(){let s=new Image;s.src=H.data,s.mimetype=H.ext,s.onload=async function(){let a={data:s.src,height:s.height,width:s.width},n=function(e,t,s=1080){let a=document.createElement("canvas"),n=e.width,o=e.height,l=s,r=s;return n>o?n>r&&(o=Math.round(o*=r/n),n=r):o>l&&(n=Math.round(n*=l/o),o=l),a.width=n,a.height=o,a.getContext("2d").drawImage(e,0,0,n,o),{data:a.toDataURL(t,1),height:o,width:n}}(s,s.mimetype,25),o=W();A=!1,Z(a.data,"image",o,myId,{data:z?.message,type:z?.type},z?.id,{reply:!!z.message,title:!!(z.message||maxUser>2)},{ext:s.mimetype,size:a.data.length,height:a.height,width:a.width,name:D.name});let l=document.getElementById(o)?.querySelector(".messageMain");l.querySelector(".image").style.filter="brightness(0.4)";let r=0;t.emit("fileUploadStart","image",n.data,myId,{data:z?.message,type:z?.type},z?.id,{reply:!!z.message,title:!!(z.message||maxUser>2)},{ext:s.mimetype,size:a.data.length,height:a.height,width:a.width,name:D.name},myKey,(t=>{y.play(),document.getElementById(o).classList.add("delevered"),document.getElementById(o).id=t,o=t,O=t,document.hasFocus()&&e.emit("seen",{userId:myId,messageId:O,avatar:myAvatar})}));let i=xe(a.data,H.name),c=new FormData;c.append("uid",myId),c.append("key",myKey),c.append("file",i),ae();let d=new XMLHttpRequest;d.open("POST",`${location.origin}/api/files`,!0),d.upload.onprogress=function(e){e.lengthComputable&&(r=e.loaded/e.total*100,l.querySelector(".sendingImage").textContent="â†‘ "+Math.round(r)+"%")},d.onload=function(e){200==this.status?(l&&(l.querySelector(".sendingImage").remove(),l.querySelector(".image").style.filter="none"),document.getElementById(o).dataset.downloaded="true",t.emit("fileUploadEnd",o,myKey,JSON.parse(e.target.response).downlink)):(console.log("error uploading image"),l.querySelector(".sendingImage").textContent=this.responseText,t.emit("fileUploadError",myKey,o,"image"))},d.send(c)}}():"file"===F&&async function(){let s=W();A=!1,Z(D.data,"file",s,myId,{data:z?.message,type:z?.type},z?.id,{reply:!!z.message,title:!!(z.message||maxUser>2)},{ext:D.ext,size:D.size,name:D.name});let a=0,n=document.getElementById(s)?.querySelector(".messageMain");t.emit("fileUploadStart","file","",myId,{data:z?.message,type:z?.type},z?.id,{reply:!!z.message,title:!!(z.message||maxUser>2)},{ext:D.ext,size:D.size,name:D.name},myKey,(t=>{y.play(),document.getElementById(s).classList.add("delevered"),document.getElementById(s).id=t,s=t,O=t,document.hasFocus()&&e.emit("seen",{userId:myId,messageId:O,avatar:myAvatar})}));let o=xe(D.data,D.name),l=new FormData;l.append("uid",myId),l.append("key",myKey),l.append("file",o),ae();let r=new XMLHttpRequest;r.open("POST",location.origin+"/api/files",!0),r.upload.onprogress=function(e){e.lengthComputable&&(a=e.loaded/e.total*100,n.querySelector(".progress").textContent="â†‘ "+Math.round(a)+"%")},r.onload=function(e){200==this.status?(document.getElementById(s).dataset.downloaded="true",n.querySelector(".progress").style.visibility="hidden",t.emit("fileUploadEnd",s,myKey,JSON.parse(e.target.response).downlink)):(console.log("error uploading file"),n.querySelector(".progress").textContent="Error",t.emit("fileUploadError",myKey,s,"image"))},r.send(l)}(),ee()})),document.getElementById("lightbox__save").addEventListener("click",(()=>{J()})),l.addEventListener("keydown",(e=>{e.ctrlKey&&"Enter"===e.key&&q.click()})),document.getElementById("send-location").addEventListener("click",(()=>{de("Tracing your location..."),navigator.geolocation?navigator.geolocation.getCurrentPosition((t=>{e.emit("createLocationMessage",{latitude:t.coords.latitude,longitude:t.coords.longitude})}),(e=>{de(e.message)})):de("Geolocation not supported by your browser.")})),document.querySelectorAll(".clickable").forEach((e=>{e.addEventListener("click",(()=>{I.currentTime=0,I.play()}))})),window.addEventListener("paste",(e=>{if(e.clipboardData){let t=e.clipboardData.items;if(t)for(let e=0;e<t.length;e++)if("file"===t[e].kind){let s=t[e].getAsFile();s.type.match("image.*")&&(H.data=s,H.ext=s.type.split("/")[1],D.name=s.name,D.size=s.size,F="image",Se(s))}}})),e.on("connect",(()=>{const t={name:myName,id:myId,avatar:myAvatar,key:myKey,maxuser:maxUser};e.emit("join",t,(function(e){e?console.log(e):(console.log("no error"),b.size>0&&(document.getElementById("typingIndicator").textContent=re(b)),document.getElementById("preload").style.display="none",de("Connected to server"),"Notification"in window&&Notification.requestPermission())}))})),e.on("updateUserList",(e=>{for(e.forEach((e=>{C.set(e.uid,e)})),document.getElementById("count").textContent=`${e.length}/${maxUser}`;document.getElementById("userlist").firstChild;)document.getElementById("userlist").removeChild(document.getElementById("userlist").firstChild);e.forEach((e=>{let t=`<li class="user" data-uid="${e.uid}"> <div class="avt"> <img src="/images/avatars/${e.avatar}(custom).png" height="30px" width="30px"/> <i class="fa-solid fa-circle activeStatus"></i> </div> ${e.uid==myId?e.name+" (You)":e.name}</li>`;if(e.uid==myId){const e=document.createRange().createContextualFragment(t);document.getElementById("userlist").prepend(e)}else{const e=document.createRange().createContextualFragment(t);document.getElementById("userlist").append(e)}}))})),e.on("server_message",((t,a)=>{switch(a){case"join":p.play();break;case"leave":h.play();break;case"location":v.play()}!function(t,a){let n=`<li class="serverMessage msg-item" id="${t.id}"> <div class="messageContainer" style="color: ${t.color}"> ${t.text} </div> <div class="seenBy"></div> </li>`;const o=document.createRange().createContextualFragment(n);s.append(o),"location"==a?oe("location",`${t.user}'s location`):"leave"==a?(b.delete(t.who),document.querySelectorAll(`.msg-item[data-seen*="${t.who}"]`).forEach((e=>{e.querySelector(`.seenBy img[data-user="${t.who}"]`)?.remove(),te(e.id)})),document.getElementById("typingIndicator").textContent=re(b),oe()):oe(),O=t.id,document.hasFocus()&&e.emit("seen",{userId:myId,messageId:O,avatar:myAvatar})}(t,a)})),e.on("newMessage",((e,t,s,a,n,o,l)=>{"text"==t?g.play():"sticker"==t&&S.play(),Z(e,t,s,a,n,o,l,{}),Le({data:"text"==t?e:"",type:t[0].toUpperCase()+t.slice(1)},C.get(a)?.name,C.get(a)?.avatar)})),e.on("seen",(e=>{let t=document.getElementById(e.messageId);if(t&&!t.dataset.seen?.includes(e.userId)){document.querySelectorAll(`.msg-item[data-seen*="${e.userId}"]`).forEach((t=>{t.querySelector(`.seenBy img[data-user="${e.userId}"]`)?.remove(),te(t?.id)})),t.dataset.seen=t.dataset.seen?t.dataset.seen+"|"+e.userId:e.userId;const s=document.createElement("img");s.src=`/images/avatars/${e.avatar}(custom)-mini.png`,s.dataset.user=e.userId,t.querySelector(".seenBy").appendChild(s),te(t.id),oe()}})),e.on("getReact",((e,t,s)=>{!function(e,t,s){try{let a=document.getElementById(t).querySelector(".reactedUsers");if(a?.querySelector(".list")){let t=a.querySelector('.list[data-uid="'+s+'"]');if(t)t.textContent==e?t.remove():t.textContent=e;else{E.play();const t=document.createDocumentFragment(),n=document.createElement("div");n.classList.add("list"),n.dataset.uid=s,n.textContent=e,t.append(n),a.append(t)}}else{const t=document.createDocumentFragment(),n=document.createElement("div");n.classList.add("list"),n.dataset.uid=s,n.textContent=e,t.append(n),a.append(t),E.play()}let n=new Map;n=function(e){let t=new Map;return e.forEach((e=>{t.set(e.textContent,t.get(e.textContent)+1||1)})),t}(Array.from(a.querySelectorAll(".list")));let o=document.getElementById(t).querySelector(".reactsOfMessage");if(o&&n.size>0){for(;o.firstChild;)o.removeChild(o.firstChild);let e=0;n.forEach(((t,s)=>{e>=2&&o.querySelector("span").remove();const a=document.createDocumentFragment(),n=document.createElement("span");n.textContent=`${s}${t}`,a.append(n),o.append(a),e++})),document.getElementById(t).classList.add("react"),te(t)}else document.getElementById(t).classList.remove("react"),document.getElementById(t).querySelector(".seenBy").style.marginTop="0px",te(t);oe()}catch(e){console.log("Message not exists")}}(e,t,s)})),e.on("deleteMessage",((e,t)=>{!function(e,t){let a=document.getElementById(e);if(a){for(;a.querySelector(".messageMain").firstChild;)a.querySelector(".messageMain").removeChild(a.querySelector(".messageMain").firstChild);const n=document.createDocumentFragment(),o=document.createElement("p");o.textContent="Deleted message",n.append(o),a.querySelector(".messageMain").append(n),a.classList.add("deleted"),a.dataset.deleted=!0,a.querySelector(".messageTitle").textContent=t,de(`${t==myName?"You":t} deleted a message`),2!=maxUser&&a.dataset.uid!=myId||(a.querySelector(".messageTitle").style.visibility="hidden"),null!=a.querySelector(".messageReply")&&(a.querySelector(".messageReply").remove(),a.querySelector(".reactsOfMessage").remove(),a.querySelector(".reactedUsers").remove(),a.classList.remove("reply"),a.classList.remove("react"),a.querySelector(".seenBy").style.marginTop="0px",te(e));let l=document.querySelectorAll(`[data-repid='${e}']`);null!=l&&l.forEach((e=>{e.classList.remove("imageReply"),e.style.background="#000000c4",e.style.color="#7d858c",e.textContent=`${t==myName?"You":t} deleted this message`})),_=s.scrollTop}}(e,t)})),e.on("typing",((e,t)=>{f.play(),b.set(t,e),document.getElementById("typingIndicator").textContent=re(b)})),e.on("stoptyping",(e=>{b.delete(e),0==b.size?document.getElementById("typingIndicator").textContent="":document.getElementById("typingIndicator").textContent=re(b)})),e.on("disconnect",(()=>{console.log("disconnected"),de("Disconnected from server")})),t.on("connect",(()=>{console.log("fileSocket connected"),t.emit("join",myKey)})),t.on("fileDownloadStart",((e,t,s,a,n,o,l,r)=>{if(g.play(),$.set(s,{type:e,data:"",uId:a,reply:n,replyId:o,options:l,metadata:r}),"image"===e){Z(t,e,s,a,n,o,l,r);let i=document.getElementById(s).querySelector(".messageMain");setTimeout((()=>{i.querySelector(".image").style.filter="brightness(0.4) url(#sharpBlur)"}),20)}else Z("",e,s,a,n,o,l,r),document.getElementById(s).querySelector(".messageMain").querySelector(".progress").textContent="â†‘ Sending";Le({data:"",type:e[0].toUpperCase()+e.slice(1)},C.get(a)?.name,C.get(a)?.avatar)})),t.on("fileUploadError",((e,t)=>{let s,a=document.getElementById(e).querySelector(".messageMain");s="image"===t?a.querySelector(".sendingImage"):a.querySelector(".progress"),s.textContent="Upload Error"})),t.on("fileDownloadReady",((e,s)=>{if(!$.has(e))return;let a,n=$.get(e).type,o=document.getElementById(e).querySelector(".messageMain");a="image"===n?o.querySelector(".sendingImage"):o.querySelector(".progress"),$.delete(e);let l=new XMLHttpRequest;l.open("GET",`${location.origin}/api/download/${s}`,!0),l.responseType="blob",l.onprogress=async function(e){if(e.lengthComputable&&a){let t=Math.round(e.loaded/e.total*100);a.textContent=`${t}%`}},l.onload=function(a){if(200==this.status){let a=this.response,l=new FileReader;l.readAsDataURL(a),l.onloadend=function(){if(o){let a=l.result;!function(e,t,s){y.play(),"image"===s?setTimeout((()=>{e.querySelector(".sendingImage").remove(),e.querySelector(".image").src=t,e.querySelector(".image").alt="image",e.querySelector(".image").style.filter="none"}),20):"file"===s&&setTimeout((()=>{e.querySelector(".file").dataset.data=t,e.querySelector(".progress").style.visibility="hidden"}),20),e.closest(".message").dataset.downloaded="true"}(o,a,n),t.emit("fileDownloaded",myId,myKey,s),"image"===n&&document.querySelectorAll(`.messageReply[data-repid="${e}"`).forEach((e=>{e.querySelector(".image").src=a}))}}}else 404==this.status&&console.log("404")},l.send(),oe()})),K(),oe(),setTimeout((()=>{document.getElementById("preload").querySelector(".text").textContent="Slow internet"}),3e3)})();