"use strict";import{errlog,usernameformat,clickSound}from"./common.min.js";const socket=io("/auth");socket.on("connect",()=>{console.log("%cConnected to auth namespace","color: deepskyblue;")});const form=document.getElementById("form"),next=document.getElementById("next"),form1=document.getElementById("subform1"),form2=document.getElementById("subform2"),keyformat=/^[a-zA-Z0-9]{2}-[a-zA-Z0-9]{3}-[a-zA-Z0-9]{2}$/;function validateKey(){const key=document.getElementById("key").value;return 0==key.length?(document.getElementById("key").focus(),errlog("keyErr",'Key is required <i class="fa-solid fa-triangle-exclamation"></i>'),document.getElementById("keyLabel").innerHTML="Enter key <i id='lb__icon' class=\"fa-solid fa-key\"></i>",!1):!!keyformat.test(key)||(document.getElementById("key").focus(),errlog("keyErr",'Key is not valid <i class="fa-solid fa-triangle-exclamation"></i>'),document.getElementById("keyLabel").innerHTML="Enter key <i id='lb__icon' class=\"fa-solid fa-key\"></i>",!1)}let usersData={};async function validateUser(){const username=document.getElementById("username").value,avatarsChecked=document.querySelector('.avatar input[type="radio"]:checked');if(0==username.length)return document.getElementById("username").focus(),errlog("usernameErr",'Username is required <i class="fa-solid fa-triangle-exclamation"></i>'),!1;if(username.length<3||username.length>20)return document.getElementById("username").focus(),errlog("usernameErr",'Name must be between 3 and 20 characters <i class="fa-solid fa-triangle-exclamation"></i>'),!1;if(!usernameformat.test(username))return document.getElementById("username").focus(),errlog("usernameErr",'Cannot contain special charecters or space <i class="fa-solid fa-triangle-exclamation"></i>'),!1;const hashes=usersData.map(userData=>userData.hash),avatarsTaken=usersData.map(userData=>userData.avatar);if(!hashes)return!1;{const encodedText=(new TextEncoder).encode(username),hashBuffer=await crypto.subtle.digest("SHA-256",encodedText),hashArray=Array.from(new Uint8Array(hashBuffer)),hashHex=hashArray.map(b=>b.toString(16).padStart(2,"0")).join("");if(hashes.includes(hashHex))return errlog("usernameErr",'Username taken <i class="fa-solid fa-triangle-exclamation"></i>'),!1}if(!avatarsChecked)return errlog("avatarErr",'Avatar is required <i class="fa-solid fa-triangle-exclamation"></i>'),!1;if(!avatarsTaken)return!1;{const selectedAvatar=document.querySelector(".avatar input[type=radio]:checked");if(!selectedAvatar)return errlog("avatarErr",'Avatar is taken by someone else <i class="fa-solid fa-triangle-exclamation"></i>'),!1;if(avatarsTaken.includes(selectedAvatar.value))return errlog("avatarErr",'Avatar is taken by someone else <i class="fa-solid fa-triangle-exclamation"></i>'),!1}return!0}async function check(){document.querySelectorAll(".errLog").forEach(elem=>{elem.textContent=""});const valid=await validateUser();return valid&&(document.getElementById("enter").innerHTML='Please Wait <i class="fa-solid fa-circle-notch fa-spin"></i>'),valid}form.addEventListener("submit",async e=>{e.preventDefault(),emitSignal(!0),validateKey()&&await check()&&usersData.forEach(userData=>{const selectedAvatar=document.querySelector(".avatar input[type=radio]:checked");selectedAvatar&&selectedAvatar.value!=userData.avatar&&(document.getElementById("enter").setAttribute("disabled","disabled"),form.submit())})});const keyElem=document.getElementById("key");function removeAvatars(){document.querySelectorAll(".avatar img.taken").forEach(elem=>{elem.classList.remove("taken")}),0!=usersData.length&&usersData.forEach(userData=>{const avatar=document.getElementById(userData.avatar);avatar&&avatar.closest(".avatar").querySelector("img").classList.add("taken")})}function emitSignal(onlySignal=!1){const key=document.getElementById("key").value;socket.emit("joinRequest",key,response=>{document.getElementById("keyLabel").innerHTML="Enter key <i id='lb__icon' class=\"fa-solid fa-key\"></i>",response.success?(usersData=response.message,removeAvatars(),onlySignal||(form1.classList.add("done"),form2.classList.add("active"))):(errlog("keyErr",`${response.message} ${response.icon}`),1==response.blocked&&(next.classList.remove("clickable"),next.innerHTML='Reload <i class="fa-solid fa-rotate-right"></i>',next.style.background="#ff2a20",next.onclick=()=>{clickSound.currentTime=0,clickSound.play(),next.innerHTML='Please wait <i class="fa-solid fa-rotate-right fa-spin"></i>',location.reload()}))})}["paste","keydown"].forEach(event=>{keyElem.addEventListener(event,e=>{"Enter"===e.key&&(e.preventDefault(),next.click()),"paste"===e.type&&setTimeout(()=>{next.click()},100)})}),socket.on("userUpdate",response=>{if(!response.success){next.disabled=!0,document.getElementById("enter").disabled=!0,errlog("usernameErr",`Key is no longer available ${response.icon}`);let i=0;setInterval(()=>{errlog("usernameErr",`Reloading in ${5-i} ${4!=i?"seconds":"second"} ${response.icon}`),i++,5==i&&location.reload()},1e3)}usersData=response.message,removeAvatars()}),socket.on("disconnect",()=>{console.log("%cDisconnected from auth namespace","color: deepskyblue;"),errlog("keyErr",'Disconnected from server <i class="fa-solid fa-triangle-exclamation"></i>'),errlog("usernameErr",'Disconnected from server <i class="fa-solid fa-triangle-exclamation"></i>'),next.disabled=!0,document.getElementById("enter").disabled=!0;let i=0;setInterval(()=>{errlog("keyErr",`Reloading after ${5-i} ${4!=i?"seconds":"second"} <i class="fa-solid fa-triangle-exclamation"></i>`),errlog("usernameErr",`Reloading after ${5-i} ${4!=i?"seconds":"second"} <i class="fa-solid fa-triangle-exclamation"></i>`),i++,5==i&&location.reload()},1e3)}),next.onclick=e=>{e.preventDefault(),document.getElementById("keyLabel").innerHTML="Checking <i id='lb__icon' class=\"fa-solid fa-circle-notch fa-spin\"></i>",validateKey()&&emitSignal()},window.autoFetch&&(emitSignal(),console.log("%cAuto-fetching key","color: limegreen;"),window.autoFetch=void 0,document.getElementById("autoFetch").remove()),console.log("%cjoinchat.js loaded","color: limegreen;");